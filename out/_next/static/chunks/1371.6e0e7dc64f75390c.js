"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1371],{6179:function(t,e,i){i.d(e,{Z:function(){return a}});const a=(0,i(1).Z)("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]])},31371:function(t,e,i){i.r(e),i.d(e,{EcosystemActivityWidget:function(){return f},default:function(){return N}});var a=i(85893),s=i(67294),r=i(37568),c=i(99724),n=i(95818),l=i(2353);class o{static getInstance(){return o.instance||(o.instance=new o),o.instance}async logActivity(t,e){try{const i=t||this.getCurrentUserId();if(!i)throw new Error("User not authenticated");const a="".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),s=(0,c.JU)((0,c.hJ)(n.db,"activities",i,"items"),a),r={id:a,timestamp:c.EK.now(),sourceApp:e.sourceApp,activityType:e.activityType,activityTitle:e.activityTitle,activityDescription:e.activityDescription,activityIcon:e.activityIcon,appIcon:e.appIcon,appColor:e.appColor,deepLink:e.deepLink,userId:i,affectedUsers:e.affectedUsers,category:e.category,priority:e.priority||"medium",visibility:e.visibility||"private",data:e.data,metadata:{source:this.getSource(),readBy:{[i]:c.EK.now()}}};return await(0,c.pl)(s,r),this.activityCache.delete(i),a}catch(i){throw i}}async getRecentActivities(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,i=arguments.length>2?arguments[2]:void 0;try{const r=t||this.getCurrentUserId();if(!r)return[];const l="".concat(r,"_").concat(e,"_").concat(JSON.stringify(i||{}));if(this.activityCache.has(l))return this.activityCache.get(l);const o=[(0,c.Xo)("timestamp","desc"),(0,c.b9)(e)];(null===i||void 0===i?void 0:i.sourceApp)&&o.push((0,c.ar)("sourceApp","==",i.sourceApp)),(null===i||void 0===i?void 0:i.priority)&&o.push((0,c.ar)("priority","==",i.priority)),(null===i||void 0===i?void 0:i.category)&&o.push((0,c.ar)("category","==",i.category));const d=(0,c.IO)((0,c.hJ)(n.db,"activities",r,"items"),...o),y=(await(0,c.PL)(d)).docs.map((t=>t.data()));if((null===i||void 0===i?void 0:i.dateFrom)||(null===i||void 0===i?void 0:i.dateTo)){var a,s;const t=(null===(a=i.dateFrom)||void 0===a?void 0:a.getTime())||0,e=(null===(s=i.dateTo)||void 0===s?void 0:s.getTime())||Date.now();return y.filter((i=>i.timestamp.toDate().getTime()>=t&&i.timestamp.toDate().getTime()<=e))}return this.activityCache.set(l,y),setTimeout((()=>this.activityCache.delete(l)),3e5),y}catch(r){return[]}}async getActivitiesByApp(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return this.getRecentActivities(t,i,{sourceApp:e})}async getActivitiesByCategory(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return this.getRecentActivities(t,i,{category:e})}async getActivitiesByDateRange(t,e,i){return this.getRecentActivities(t,100,{dateFrom:e,dateTo:i})}subscribeToActivities(t,e,i){try{const a=t||this.getCurrentUserId();if(!a)return()=>{};const s=[(0,c.Xo)("timestamp","desc"),(0,c.b9)(20)];(null===i||void 0===i?void 0:i.sourceApp)&&s.push((0,c.ar)("sourceApp","==",i.sourceApp)),(null===i||void 0===i?void 0:i.category)&&s.push((0,c.ar)("category","==",i.category)),(null===i||void 0===i?void 0:i.priority)&&s.push((0,c.ar)("priority","==",i.priority));const r=(0,c.IO)((0,c.hJ)(n.db,"activities",a,"items"),...s),l="".concat(a,"_").concat(JSON.stringify(i||{})),o=this.realtimeListeners.get(l);o&&o();const d=(0,c.cf)(r,(t=>{const i=t.docs.map((t=>t.data()));e(i)}),(t=>{e([])}));return this.realtimeListeners.set(l,d),()=>{d(),this.realtimeListeners.delete(l)}}catch(a){return()=>{}}}async getActivityById(t,e){try{const i=t||this.getCurrentUserId();if(!i)return null;const a=(0,c.JU)(n.db,"activities",i,"items",e),s=await(0,c.QT)(a);return s.exists()?s.data():null}catch(i){return null}}async updateActivityRead(t,e){try{const i=t||this.getCurrentUserId();if(!i)return;const a=(0,c.JU)(n.db,"activities",i,"items",e);await(0,c.r7)(a,{["metadata.readBy.".concat(i)]:c.EK.now()}),this.activityCache.clear()}catch(i){}}async deleteActivity(t,e){try{const i=t||this.getCurrentUserId();if(!i)return;const a=(0,c.JU)(n.db,"activities",i,"items",e);await(0,c.r7)(a,{"metadata.deletedAt":c.EK.now()}),this.activityCache.clear()}catch(i){}}async triggerSync(t){try{const e=t||this.getCurrentUserId();if(!e)return{success:!1,activitiesCount:0,lastSyncDate:new Date,error:"No user authenticated"};const i=this.lastSyncAttempt.get(e)||0,a=Date.now()-i;if(a<this.syncThrottleMs){const t=Math.ceil((this.syncThrottleMs-a)/1e3);return{success:!1,activitiesCount:0,lastSyncDate:new Date(i),error:"Sync throttled. Try again in ".concat(t,"s")}}this.lastSyncAttempt.set(e,Date.now()),this.activityCache.clear();return{success:!0,activitiesCount:(await this.getRecentActivities(e,100)).length,lastSyncDate:new Date}}catch(e){return{success:!1,activitiesCount:0,lastSyncDate:new Date,error:String(e)}}}async getActivityStats(t){try{var e,i;const a=t||this.getCurrentUserId();if(!a)return{totalActivities:0,activitiesByApp:{},activitiesByCategory:{},activitiesByDay:{},averageActivitiesPerDay:0,mostActiveApp:"",mostActiveCategory:"",unreadCount:0,lastActivityTime:null};const s=await this.getRecentActivities(a,1e3),r={totalActivities:s.length,activitiesByApp:{},activitiesByCategory:{},activitiesByDay:{},averageActivitiesPerDay:0,mostActiveApp:"",mostActiveCategory:"",unreadCount:0,lastActivityTime:(null===(i=s[0])||void 0===i||null===(e=i.timestamp)||void 0===e?void 0:e.toDate())||null};s.forEach((t=>{var e;r.activitiesByApp[t.sourceApp]=(r.activitiesByApp[t.sourceApp]||0)+1,r.activitiesByCategory[t.category]=(r.activitiesByCategory[t.category]||0)+1;const i=t.timestamp.toDate().toISOString().split("T")[0];r.activitiesByDay[i]=(r.activitiesByDay[i]||0)+1,(null===(e=t.metadata)||void 0===e?void 0:e.readBy)&&t.metadata.readBy[a]||(r.unreadCount+=1)})),r.mostActiveApp=Object.keys(r.activitiesByApp).sort(((t,e)=>r.activitiesByApp[e]-r.activitiesByApp[t]))[0]||"",r.mostActiveCategory=Object.keys(r.activitiesByCategory).sort(((t,e)=>r.activitiesByCategory[e]-r.activitiesByCategory[t]))[0]||"";const c=Object.keys(r.activitiesByDay).length;return r.averageActivitiesPerDay=c>0?Math.round(r.totalActivities/c):0,r}catch(a){return{totalActivities:0,activitiesByApp:{},activitiesByCategory:{},activitiesByDay:{},averageActivitiesPerDay:0,mostActiveApp:"",mostActiveCategory:"",unreadCount:0,lastActivityTime:null}}}cleanup(){this.realtimeListeners.forEach((t=>t())),this.realtimeListeners.clear(),this.activityCache.clear(),this.lastSyncAttempt.clear()}getCurrentUserId(){var t;return(null===(t=(0,l.v0)().currentUser)||void 0===t?void 0:t.uid)||""}getSource(){return/mobile|android|iphone/i.test(navigator.userAgent)?"mobile":"web"}constructor(){this.activityCache=new Map,this.realtimeListeners=new Map,this.lastSyncAttempt=new Map,this.syncThrottleMs=5e3}}const d=o.getInstance();var y=i(2461),u=i(19078),p=i(42392),m=i(31928),v=i(6179),g=i(69972),h=i(91560);const x={LifeSync:{color:"#6366F1",icon:"\ud83d\udc64",displayName:"LifeSync"},Hub:{color:"#3B82F6",icon:"\ud83c\udfe0",displayName:"Hub"},BizHelp:{color:"#EC4899",icon:"\ud83d\udcbc",displayName:"BizHelp"},FinHelp:{color:"#10B981",icon:"\ud83d\udcb0",displayName:"FinHelp"},SafetyHelp:{color:"#EF4444",icon:"\ud83d\udee1\ufe0f",displayName:"SafetyHelp"},PigeeBack:{color:"#F59E0B",icon:"\ud83d\ude97",displayName:"PigeeBack"},Ekhaya:{color:"#8B5CF6",icon:"\ud83e\udd1d",displayName:"Ekhaya"},DocHelp:{color:"#06B6D4",icon:"\ud83d\udcc4",displayName:"DocHelp"},SaziAcademy:{color:"#14B8A6",icon:"\ud83c\udf93",displayName:"Sazi Academy"}},b={low:"bg-gray-100 text-gray-800",medium:"bg-blue-100 text-blue-800",high:"bg-yellow-100 text-yellow-800",critical:"bg-red-100 text-red-800"},f=t=>{let{userId:e,limit:i=10,mode:c="full",showFilters:n=!0,initialFilters:l,showStats:o=!0,onActivityClick:g,className:h=""}=t;const{user:b}=(0,r.a)(),f=e||(null===b||void 0===b?void 0:b.id),[N,w]=(0,s.useState)([]),[k,D]=(0,s.useState)(null),[B,S]=(0,s.useState)(!0),[T,U]=(0,s.useState)(!1),[I,z]=(0,s.useState)(null),[M,E]=(0,s.useState)(l||{}),[L,R]=(0,s.useState)(!1),F=s.useRef(null);(0,s.useEffect)((()=>{if(!f)return void S(!1);S(!0),F.current=d.subscribeToActivities(f,(t=>{w(t),S(!1)}),M);return o&&(async()=>{const t=await d.getActivityStats(f);D(t)})(),()=>{F.current&&F.current()}}),[f,o,M]);const H=(0,s.useCallback)((async()=>{if(f){U(!0);try{const t=await d.triggerSync(f);t.success||z(t.error||"Sync failed")}catch(t){z("Failed to sync activities")}finally{U(!1)}}}),[f]),P=(0,s.useCallback)((t=>{if(null===g||void 0===g||g(t),t.deepLink){const e=new URL(t.deepLink,window.location.origin);e.searchParams.append("referrer","ecosystem-activity"),e.searchParams.append("returnUrl",window.location.href),window.location.href=e.toString()}}),[g]),O=(0,s.useCallback)((async(t,e)=>{t.stopPropagation(),f&&await d.updateActivityRead(f,e.id)}),[f]),Z=(0,s.useCallback)((async(t,e)=>{t.stopPropagation(),f&&await d.deleteActivity(f,e.id)}),[f]),J=(0,s.useCallback)((t=>{E(t)}),[]),_=t=>{var e;const i=(null===t||void 0===t||null===(e=t.toDate)||void 0===e?void 0:e.call(t))||new Date(t),a=(new Date).getTime()-i.getTime(),s=Math.floor(a/6e4),r=Math.floor(a/36e5),c=Math.floor(a/864e5);return s<1?"Just now":s<60?"".concat(s,"m ago"):r<24?"".concat(r,"h ago"):c<7?"".concat(c,"d ago"):i.toLocaleDateString()},K="compact"===c?N.slice(0,4):N.slice(0,i),V=t=>{var e,i;return!!(null===(i=t.metadata)||void 0===i||null===(e=i.readBy)||void 0===e?void 0:e[f])};return(0,a.jsxs)("div",{className:"ecosystem-activity-widget space-y-4 ".concat(h),"data-testid":"ecosystem-activity-widget",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Ecosystem Activity"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Real-time updates from all your apps"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:H,disabled:T||B,className:"p-2 rounded-lg transition-colors ".concat(T||B?"bg-gray-200 cursor-not-allowed":"bg-gray-100 hover:bg-gray-200 text-gray-700"),title:"Refresh activities",children:(0,a.jsx)(y.Z,{size:18,className:T?"animate-spin":""})}),n&&(0,a.jsx)("button",{onClick:()=>R(!L),className:"p-2 rounded-lg transition-colors ".concat(L?"bg-blue-100 text-blue-700":"bg-gray-100 hover:bg-gray-200 text-gray-700"),title:"Toggle filters",children:(0,a.jsx)(u.Z,{size:18})})]})]}),o&&k&&(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,a.jsx)(A,{label:"Total Activities",value:k.totalActivities,icon:"\ud83d\udcca"}),(0,a.jsx)(A,{label:"Most Active App",value:k.mostActiveApp,icon:"\ud83c\udfc6"}),(0,a.jsx)(A,{label:"This Week",value:k.activitiesByDay?Object.keys(k.activitiesByDay).length:0,icon:"\ud83d\udcc5"}),(0,a.jsx)(A,{label:"Unread",value:k.unreadCount,icon:"\ud83d\udd14"})]}),L&&n&&(0,a.jsx)(C,{filters:M,onFilterChange:J}),I&&(0,a.jsxs)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3",children:[(0,a.jsx)(p.Z,{className:"text-red-600 flex-shrink-0 mt-0.5",size:18}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-red-900",children:I}),(0,a.jsx)("button",{onClick:()=>z(null),className:"text-sm text-red-700 hover:text-red-900 mt-1",children:"Dismiss"})]})]}),B&&0===N.length&&(0,a.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(m.Z,{className:"mx-auto mb-2 text-gray-400 animate-spin",size:32}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Loading activities..."})]})}),!B&&0===N.length&&(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("p",{className:"text-gray-500",children:"No activities yet"}),(0,a.jsx)("p",{className:"text-sm text-gray-400 mt-1",children:"Activities from all your apps will appear here"})]}),K.length>0&&(0,a.jsx)("div",{className:"space-y-2",children:K.map((t=>{return(0,a.jsx)(j,{activity:t,isRead:V(t),appMetadata:(e=t.sourceApp,x[e]||x.Hub),formatDate:_,onActivityClick:P,onMarkRead:O,onDelete:Z,mode:c},t.id);var e}))}),"compact"===c&&N.length>4&&(0,a.jsxs)("button",{className:"w-full px-4 py-2 text-center text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors flex items-center justify-center gap-2",children:["View all activities",(0,a.jsx)(v.Z,{size:16})]}),T&&(0,a.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500",children:[(0,a.jsx)(m.Z,{size:14,className:"animate-spin"}),"Syncing..."]})]})},A=t=>{let{label:e,value:i,icon:s}=t;return(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,a.jsx)("div",{className:"text-2xl mb-1",children:s}),(0,a.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:i}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:e})]})},j=t=>{let{activity:e,isRead:i,appMetadata:s,formatDate:r,onActivityClick:c,onMarkRead:n,onDelete:l,mode:o}=t;return(0,a.jsx)("div",{onClick:()=>c(e),className:"p-4 rounded-lg border-2 transition-all cursor-pointer hover:shadow-md ".concat(i?"bg-gray-50 border-gray-200 hover:border-gray-300":"bg-blue-50 border-blue-200 hover:border-blue-300"),children:(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"text-2xl flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-lg",style:{backgroundColor:"".concat(s.color,"20")},children:s.icon}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,a.jsx)("p",{className:"font-semibold text-gray-900",children:e.activityTitle}),(0,a.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full",style:{backgroundColor:"".concat(s.color,"20"),color:s.color},children:s.displayName}),"medium"!==e.priority&&(0,a.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat(b[e.priority]),children:e.priority})]}),e.activityDescription&&"full"===o&&(0,a.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.activityDescription}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:r(e.timestamp)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[!i&&(0,a.jsx)("button",{onClick:t=>n(t,e),className:"p-1 text-gray-400 hover:text-gray-600 rounded",title:"Mark as read",children:(0,a.jsx)(g.Z,{size:16})}),(0,a.jsx)("button",{onClick:t=>l(t,e),className:"p-1 text-gray-400 hover:text-red-600 rounded",title:"Delete",children:(0,a.jsx)(h.Z,{size:16})})]})]}),e.deepLink&&"full"===o&&(0,a.jsxs)("button",{onClick:()=>c(e),className:"mt-2 text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 font-medium",children:["View in ",s.displayName,(0,a.jsx)(v.Z,{size:12})]})]})]})})},C=t=>{let{filters:e,onFilterChange:i}=t;return(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 space-y-4 border border-gray-200",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Apps"}),(0,a.jsx)("select",{multiple:!0,value:e.sourceApps||[],onChange:t=>{const a=Array.from(t.target.selectedOptions,(t=>t.value));i({...e,sourceApps:a.length>0?a:void 0})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",size:3,children:["LifeSync","Hub","BizHelp","FinHelp","SafetyHelp","PigeeBack","Ekhaya","DocHelp","SaziAcademy"].map((t=>(0,a.jsx)("option",{value:t,children:x[t].displayName},t)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Categories"}),(0,a.jsx)("select",{multiple:!0,value:e.categories||[],onChange:t=>{const a=Array.from(t.target.selectedOptions,(t=>t.value));i({...e,categories:a.length>0?a:void 0})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",size:3,children:["profile","business","finance","safety","community","learning","document"].map((t=>(0,a.jsx)("option",{value:t,children:t.charAt(0).toUpperCase()+t.slice(1)},t)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Priority"}),(0,a.jsx)("select",{multiple:!0,value:e.priorities||[],onChange:t=>{const a=Array.from(t.target.selectedOptions,(t=>t.value));i({...e,priorities:a.length>0?a:void 0})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",size:3,children:["low","medium","high","critical"].map((t=>(0,a.jsx)("option",{value:t,children:t.charAt(0).toUpperCase()+t.slice(1)},t)))})]})]}),(0,a.jsx)("button",{onClick:()=>{i({})},className:"text-sm text-gray-600 hover:text-gray-900 font-medium",children:"Clear all filters"})]})};var N=f}}]);